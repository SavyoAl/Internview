<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interview Session</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    @keyframes blink {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    .blinking-cursor::after {
      content: '|';
      animation: blink 1s step-end infinite;
      margin-left: 2px;
      color: #555;
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
</head>
<body class="bg-white flex min-h-screen font-sans">

  <!-- Sidebar -->
  <aside class="w-64 border-r border-pink-200 p-4">
    <button onclick="window.location.href='home.html'" class="bg-pink-500 text-white px-3 py-2 text-sm rounded-md w-full mb-4 hover:bg-pink-600">
      ‚¨Ö Back to home
    </button>
    <h2 class="text-xs text-gray-500 uppercase mb-2">Chats</h2>
    <div id="chat-history" class="space-y-2 text-sm text-gray-700">
      <p class="text-gray-400">No chats yet</p>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col items-center px-8 py-10 overflow-y-auto">
    <div class="text-center mb-6">
      <h1 class="text-2xl font-semibold text-black">
        Anxious About the <span class="inline-block bg-pink-500 text-white px-3 py-1 rounded-full shadow-sm text-base align-middle">Interview?</span>
      </h1>
      <p class="text-gray-500 text-sm mt-2 font-medium">I'm here to help you practice</p>
    </div>

    <div id="chat-messages" class="w-full max-w-2xl space-y-4 mb-6 flex flex-col"></div>

    <div class="flex flex-col items-center w-full max-w-2xl">
      <textarea id="user-answer" placeholder="Type your message..." rows="3"
        class="w-full border border-pink-300 rounded-lg p-3 text-sm resize-none mb-3 focus:outline-none focus:ring-2 focus:ring-pink-300"></textarea>

      <div class="flex gap-2 self-end">
        <button id="record-button" class="bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded hover:bg-gray-300">üé§ Speak</button>
        <button id="stop-button" class="bg-red-500 text-white px-3 py-1 text-sm rounded hidden">‚èπÔ∏è Stop</button>
        <button id="submit-answer" class="bg-pink-500 text-white px-4 py-1 text-sm rounded hover:bg-pink-600">‚û§</button>
      </div>
    </div>

    <div id="timer" class="text-xs text-gray-400 mt-2 hidden">Recording: <span id="time">0</span>s</div>
    <button id="next-question" class="mt-6 hidden bg-green-600 text-white px-4 py-2 text-sm rounded hover:bg-green-700">Next Question ‚Üí</button>
  </main>

  <script>
    let storedRole = "";
    let storedCompany = "";
    let introComplete = false;

    // ‚úÖ Generate session ID and store it in localStorage
    const sessionId = localStorage.getItem("chatSessionId") || crypto.randomUUID();
    localStorage.setItem("chatSessionId", sessionId);

    // ‚úÖ Save messages to Supabase
    function saveChat(message, sender = "user") {
      fetch("http://localhost:5000/api/save-chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          session_id: sessionId,
          role: storedRole,
          company: storedCompany,
          message,
          sender
        })
      }).catch(err => console.error("Save failed", err));
    }
    function appendMessage(text, type = "bot") {
      const chat = document.createElement("div");
      chat.className = `max-w-[75%] px-4 py-2 rounded-lg shadow text-sm whitespace-pre-wrap ${
        type === "user"
          ? "self-end bg-pink-100 text-right text-black ml-auto"
          : type === "info"
          ? "bg-pink-500 text-white font-medium text-left"
          : "bg-gray-100 text-gray-800 text-left"
      }`;
      chat.innerText = text;
      document.getElementById("chat-messages").appendChild(chat);
      chat.scrollIntoView({ behavior: "smooth" });
    }

    function appendTypingMessage(fullText, speed = 20) {
      return new Promise(resolve => {
        const container = document.getElementById("chat-messages");
        const bubble = document.createElement("div");
        bubble.className = "max-w-[75%] px-4 py-2 rounded-lg shadow text-sm whitespace-pre-wrap bg-gray-100 text-gray-800 text-left blinking-cursor";
        container.appendChild(bubble);

        let index = 0;
        const interval = setInterval(() => {
          if (index < fullText.length) {
            bubble.textContent += fullText.charAt(index);
            index++;
            container.scrollTop = container.scrollHeight;
          } else {
            clearInterval(interval);
            bubble.classList.remove("blinking-cursor");
            resolve();
          }
        }, speed);
      });
    }

    async function generateInterviewQuestion() {
      if (!introComplete) return;
      document.getElementById("next-question").classList.add("hidden");

      const res = await fetch("http://localhost:5000/api/question", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ role: storedRole, company: storedCompany })
      });

      const data = await res.json();
      await appendTypingMessage(data.question);
      saveChat(data.question, "bot");
    }

    async function evaluateUserAnswer(mode = "typed") {
      const inputEl = document.getElementById("user-answer");
      const userAnswer = inputEl.value;
      inputEl.value = ""; // Clear text box immediately

      if (!userAnswer.trim()) return alert("Please provide an answer first.");
      appendMessage(userAnswer, "user");
      saveChat(userAnswer, "user");
      if (!introComplete) {
        try {
          const res = await fetch("http://localhost:5000/api/extract-role-company", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ intro: userAnswer })
          });

          const data = await res.json();
          storedRole = data.role || "Intern";
          storedCompany = data.company || "N/A";
          introComplete = true;

          await appendTypingMessage(`Thanks! Preparing your interview session for a ${storedRole} at ${storedCompany}...`);
          await generateInterviewQuestion();
        } catch (err) {
          console.error("Role/Company extraction failed", err);
          await appendTypingMessage("Hmm, I couldn't detect the role and company. Could you rephrase it?");
        }
        return;
      }

      const res = await fetch("http://localhost:5000/api/evaluate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answer: userAnswer, role: storedRole, company: storedCompany })
      });

      const data = await res.json();
      await appendTypingMessage(data.feedback);
      saveChat(data.feedback, "bot");
      document.getElementById("next-question").classList.remove("hidden");
    }

    let mediaRecorder;
    let audioChunks = [];
    let timerInterval;
    let seconds = 0;

    function startTimer() {
      seconds = 0;
      document.getElementById("time").innerText = seconds;
      document.getElementById("timer").classList.remove("hidden");
      timerInterval = setInterval(() => {
        seconds++;
        document.getElementById("time").innerText = seconds;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById("timer").classList.add("hidden");
      document.getElementById("time").innerText = "0";
    }

    document.getElementById("record-button").addEventListener("click", async () => {
      audioChunks = [];
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        stopTimer();
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", blob);

        try {
          const res = await fetch("http://localhost:5000/api/transcribe", {
            method: "POST",
            body: formData
          });

          const data = await res.json();
          document.getElementById("user-answer").value = data.transcript;
          evaluateUserAnswer("voice");
        } catch (err) {
          alert("Error transcribing voice. Please try again.");
          console.error(err);
        }

        document.getElementById("record-button").classList.remove("hidden");
        document.getElementById("stop-button").classList.add("hidden");
      };

      mediaRecorder.start();
      startTimer();
      document.getElementById("record-button").classList.add("hidden");
      document.getElementById("stop-button").classList.remove("hidden");
    });

    document.getElementById("stop-button").addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    });

    document.getElementById("submit-answer").addEventListener("click", () => evaluateUserAnswer("typed"));
    document.getElementById("next-question").addEventListener("click", generateInterviewQuestion);

    // ‚úÖ New: Send with Enter (Shift+Enter for newline)
    document.getElementById("user-answer").addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        evaluateUserAnswer("typed");
      }
    });

    function renderChatHistory() {
      const historyBox = document.getElementById("chat-history");
      const allChats = JSON.parse(localStorage.getItem("chatSessions")) || [];
      if (!allChats.length) {
        historyBox.innerHTML = "<p class='text-gray-400'>No chats yet</p>";
        return;
      }
      historyBox.innerHTML = allChats.map(chat =>
        `<div class="p-2 border rounded hover:bg-gray-100 cursor-pointer">
          ${chat.role}<br><span class="text-xs text-gray-400">${chat.timestamp}</span>
        </div>`
      ).join("");
    }

    window.onload = async () => {
      document.getElementById("chat-messages").innerHTML = "";
      await appendTypingMessage("Hi there üëã Before we begin, can you confirm the role and company you're applying for?");
      renderChatHistory();
    };
    
  </script>
</body>
</html>

