<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interview Session</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
</head>
<body class="bg-white flex min-h-screen font-sans">

  <!-- Sidebar -->
  <aside class="w-64 border-r border-pink-200 p-4">
    <button onclick="window.location.href='index.html'" class="bg-pink-500 text-white px-3 py-2 text-sm rounded-md w-full mb-4 hover:bg-pink-600">
      ‚¨Ö Back to home
    </button>
    <h2 class="text-xs text-gray-500 uppercase mb-2">Chats</h2>
    <div id="chat-history" class="space-y-2 text-sm text-gray-700">
      <p class="text-gray-400">No chats yet</p>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col items-center px-8 py-10 overflow-y-auto">
    <div class="text-center mb-6">
      <h1 class="text-2xl font-semibold text-black">
        Anxious About the <span class="inline-block bg-pink-500 text-white px-3 py-1 rounded-full shadow-sm text-base align-middle">Interview?</span>
      </h1>
      <p class="text-gray-500 text-sm mt-2 font-medium">I'm here to help you practice</p>
    </div>

    <!-- Chat Bubble Messages -->
    <div id="chat-messages" class="w-full max-w-2xl space-y-4 mb-6 flex flex-col"></div>

    <!-- Input Box -->
    <div class="flex flex-col items-center w-full max-w-2xl">
      <textarea id="user-answer" placeholder="Type your message..." rows="3"
        class="w-full border border-pink-300 rounded-lg p-3 text-sm resize-none mb-3 focus:outline-none focus:ring-2 focus:ring-pink-300"></textarea>

      <div class="flex gap-2 self-end">
        <button id="record-button" class="bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded hover:bg-gray-300">üé§ Speak</button>
        <button id="stop-button" class="bg-red-500 text-white px-3 py-1 text-sm rounded hidden">‚èπÔ∏è Stop</button>
        <button id="submit-answer" class="bg-pink-500 text-white px-4 py-1 text-sm rounded hover:bg-pink-600">‚û§</button>
      </div>
    </div>

    <div id="timer" class="text-xs text-gray-400 mt-2 hidden">Recording: <span id="time">0</span>s</div>
    <button id="next-question" class="mt-6 hidden bg-green-600 text-white px-4 py-2 text-sm rounded hover:bg-green-700">Next Question ‚Üí</button>
  </main>

  <!-- Embedded JavaScript -->
  <script>
    const role = localStorage.getItem("interviewRole") || "Intern";
    const company = localStorage.getItem("interviewCompany") || "";

    function appendMessage(text, type = "bot") {
      const chat = document.createElement("div");
      chat.className = `max-w-[75%] px-4 py-2 rounded-lg shadow text-sm whitespace-pre-wrap ${
        type === "user"
          ? "self-end bg-pink-100 text-right text-black ml-auto"
          : type === "info"
          ? "bg-pink-500 text-white font-medium text-left"
          : "bg-gray-100 text-gray-800 text-left"
      }`;
      chat.innerText = text;

      const container = document.getElementById("chat-messages");
      container.appendChild(chat);
      container.scrollTop = container.scrollHeight;
    }

    async function generateInterviewQuestion() {
      document.getElementById("next-question").classList.add("hidden");
      document.getElementById("user-answer").value = "";

      appendMessage(`Hi there üëã Before we begin, can you confirm the role and company you're applying for?`, "bot");
      appendMessage(`Role: ${role || "N/A"}\nCompany: ${company || "N/A"}`, "info");
      appendMessage("Loading your first question... üéØ", "bot");

      const res = await fetch("http://localhost:5000/api/question", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ role, company })
      });

      const data = await res.json();
      appendMessage(data.question, "bot");
    }

    async function evaluateUserAnswer(mode = "typed") {
      const userAnswer = document.getElementById("user-answer").value;
      if (!userAnswer.trim()) return alert("Please provide an answer first.");

      appendMessage(userAnswer, "user");

      const res = await fetch("http://localhost:5000/api/evaluate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answer: userAnswer, company })
      });

      const data = await res.json();
      appendMessage(data.feedback, "bot");
      document.getElementById("next-question").classList.remove("hidden");

      let allChats = JSON.parse(localStorage.getItem("chatSessions")) || [];
      const timestamp = new Date().toLocaleString();
      if (!allChats.some(c => c.role === role)) {
        allChats.push({ role, timestamp });
        localStorage.setItem("chatSessions", JSON.stringify(allChats));
        renderChatHistory();
      }
    }

    let mediaRecorder;
    let audioChunks = [];
    let timerInterval;
    let seconds = 0;

    function startTimer() {
      seconds = 0;
      document.getElementById("time").innerText = seconds;
      document.getElementById("timer").classList.remove("hidden");
      timerInterval = setInterval(() => {
        seconds++;
        document.getElementById("time").innerText = seconds;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById("timer").classList.add("hidden");
      document.getElementById("time").innerText = "0";
    }

    document.getElementById("record-button").addEventListener("click", async () => {
      audioChunks = [];
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        stopTimer();
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", blob);

        try {
          const res = await fetch("http://localhost:5000/api/transcribe", {
            method: "POST",
            body: formData
          });

          const data = await res.json();
          document.getElementById("user-answer").value = data.transcript;
          evaluateUserAnswer("voice");
        } catch (err) {
          alert("Error transcribing voice. Please try again.");
          console.error(err);
        }

        document.getElementById("record-button").classList.remove("hidden");
        document.getElementById("stop-button").classList.add("hidden");
      };

      mediaRecorder.start();
      startTimer();
      document.getElementById("record-button").classList.add("hidden");
      document.getElementById("stop-button").classList.remove("hidden");
    });

    document.getElementById("stop-button").addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    });

    document.getElementById("submit-answer").addEventListener("click", () => evaluateUserAnswer("typed"));
    document.getElementById("next-question").addEventListener("click", generateInterviewQuestion);

    function renderChatHistory() {
      const historyBox = document.getElementById("chat-history");
      const allChats = JSON.parse(localStorage.getItem("chatSessions")) || [];
      if (!allChats.length) {
        historyBox.innerHTML = "<p class='text-gray-400'>No chats yet</p>";
        return;
      }
      historyBox.innerHTML = allChats.map(chat =>
        `<div class="p-2 border rounded hover:bg-gray-100 cursor-pointer">
          ${chat.role}<br><span class="text-xs text-gray-400">${chat.timestamp}</span>
        </div>`
      ).join("");
    }

    window.onload = () => {
      generateInterviewQuestion();
      renderChatHistory();
    };
  </script>
</body>
</html>
